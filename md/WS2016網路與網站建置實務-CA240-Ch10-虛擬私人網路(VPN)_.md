第 10 章 虛擬私人網路\(VPN\)

10\-1 虛擬私人網路（VPN）概觀

10\-2 PPTP VPN實例演練

10\-3 L2TP VPN實例演練 – 預先共用金鑰

10\-4 L2TP VPN實例演練 – 電腦憑證

10\-5 SSTP VPN實例演練

10\-6 IKEv2 VPN實例演練 – 使用者驗證

10\-7 IKEv2 VPN實例演練 – 電腦驗證

10\-8 站台對站台PPTP VPN實例演練

10\-9 站台對站台L2TP VPN－預先共用金鑰

10\-10 利用瀏覽器申請電腦憑證

10\-11 網路原則

# 虛擬私人網路(VPN)概觀

* 遠端存取VPN連線
  * 遠地使用者可以透過網際網路來與公司內部網路建立VPN，讓使用者能夠安全的存取公司網路內的資源
* 站台對站台VPN連線
  * 讓分佈於不同地點的網路之間透過網際網路來建立安全的私人通道

# 遠端存取VPN連線

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_0.png)

VPN用戶端透過網際網路與VPN伺服器建立VPN後，就可以透過VPN來與內部電腦安全的溝通，VPN用戶端感覺上好像就是在公司內部網路的電腦上工作

# 站台對站台VPN連線

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_1.png)

又稱為 __路由器對路由器__  __VPN__  __連線__

兩個區域網路的VPN伺服器透過網際網路建立VPN後，讓兩個網路內的電腦相互之間可以透過VPN來安全的溝通。兩地的電腦感覺上好像是位於同一個地點

此時的VPN伺服器又被稱為 __VPN__  __閘道器__

# 遠端存取通訊協定

讓分別位於兩地的用戶端與伺服器、伺服器與伺服器之間能夠相互溝通。Windows Server 2016所支援的遠端存取通訊協定為PPP\(Point\-to\-Point Protocol\)

分別位於兩地、採用TCP/IP的兩台電腦之間相互溝通的IP封包\(IP datagram\)可以被封裝到PPP封包\(PPP frame\)內來傳送

PPP是目前最被廣泛使用的遠端存取通訊協定，而且其安全措施佳、擴充性較強，能夠符合目前與未來的需求

大部分的ISP都會提供讓客戶利用PPP來連接到網際網路的服務，例如xDSL撥接上網的PPPoE\(PPP over Ethernet\)

# 驗證通訊協定

* VPN用戶端連接到遠端VPN伺服器或VPN伺服器連接到另外一台VPN伺服器，都必須驗證使用者的身分
* Windows Server 2016支援以下的驗證通訊協定：
  * PAP \(Password Authentication Protocol\)
  * CHAP \(Challenge Handshake Authentication Protocol\)
  * MS\-CHAP v2 \(Microsoft Challenge Handshake Authentication Protocol Version 2\)
  * EAP \(Extensible Authentication Protocol\)

# PAP

用戶端傳送到VPN伺服器的密碼是以 __明文__ \(clear text\)的形式來傳送，也就是沒有經過加密，因此若傳送過程中被攔截的話，密碼就會外洩，因此比較不安全

# CHAP

* 採用 __挑戰__  __\-__  __回應的__ 方式來驗證使用者身份，它不會在網路上直接傳送使用者的密碼，比PAP安全
* 用戶端使用者連接到VPN伺服器時:
  * 伺服器會傳送 __挑戰訊息__ 給用戶端電腦
  * 用戶端根據 __挑戰訊息__ 的內容與使用者的密碼來計算出雜奏值，並將此雜奏值傳給VPN伺服器\(採標準的MD\-5演算法來計算雜奏值\)
  * VPN伺服器收到雜奏值後，會到使用者帳戶資料庫讀取使用者的密碼，然後根據它來計算出新的雜奏值，若此新雜奏值與用戶端所傳來的相同，就允許用戶端使用者來連線
* 使用者儲存在帳戶資料庫內的密碼必須以 __可回復__ \(reversible\)的方式來儲存
  * 例如在AD DS資料庫內的使用者帳戶需勾選 __使用可回復加密來存放密碼__ 後，再重新設定密碼
* PAP與CHAP並不提供使用者變更密碼的功能，故若使用者在登入時密碼使用期限過期的話，將無法登入

---

PAP與CHAP：建議在使用者帳戶的內容勾選密碼永久有效

# MS-CHAP v2

* 也是採用 __挑戰__  __\-__  __回應__ 的方式來驗證使用者的身份，不過使用者儲存在帳戶資料庫內的密碼不需要以 __可回復__ 的方式來儲存
* 具備相互驗證功能
  * 不但可以讓VPN伺服器來驗證用戶端使用者的身份，還可以讓用戶端來驗證VPN伺服器的電腦身份
* 支援使用者變更密碼的功能

\*從Windows Vista與Windows Server 2008開始已經不支援MS\-CHAP v1

# EAP

* 允許自訂驗證方法
* 在Windows Server 2016內所支援的EAP\-TLS是利用憑證來驗證身份
  * 使用者利用智慧卡來驗證身分的話，需使用EAP\-TLS
  * 具備雙向驗證的功能
  * VPN伺服器必須是AD DS網域的成員
* 廠商可以自行開發EAP驗證方法
  * 例如視網膜驗證、指紋驗證
* Windows Server 2016還支援PEAP通訊協定
  * 用戶端連接802\.1X無線基地台、802\.1X交換器、VPN伺服器與遠端桌面閘道等存取伺服器時，可以使用PEAP

---

PEAP：Protected Extensible Authentication Protocol

# VPN通訊協定

雙方之間所傳送的資料會被VPN通訊協定加密，可以確保資料傳送的安全性

Windows系統所支援的VPN通訊協定

| VPN通訊協定 | 支援的Windows<br />作業系統 | 部署方式 | 行動能力 | 加密方法 |
| :-: | :-: | :-: | :-: | :-: |
| PPTP | XP、Vista、Win7、Win8(8.1)、Win10 | 遠端存取 | 無 | RC4 |
|  | 2003(R2)、2008(R2)、2012(R2)、2016 | 遠端存取、站台對站台 |  |  |
| L2TP | XP、Vista、Win7、Win8(8.1) 、Win10 | 遠端存取 | 無 | DES、3DES、AES |
|  | 2003(R2)、2008(R2)、2012(R2)、2016 | 遠端存取、站台對站台 |  |  |
| SSTP | Vista SP1、2008(R2)、Win7、Win8(8.1)、Win10、2012(R2)、2016 | 遠端存取 | 無 | RC4、AES |
| IKEv2 | Win7、Win8(8.1)、Win10、2008 R2 | 遠端存取 | 有 | 3DES、AES |
|  | 2012(R2)、2016 | 遠端存取、站台對站台 |  |  |

# PPTP通訊協定

* 建置VPN最容易使用的通訊協定
* 驗證方法
  * MS\-CHAP v2\(預設\)
    * 建議密碼最好複雜一點，以降低被破解的機率
  * EAP\-TLS憑證驗證\(安全性更好\)
* 加密方法
  * MPPE，僅支援128位元的RC4加密方式

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_2.png)

---

從Windows Vista開始已經不支援40與56位元

# L2TP(L2TP/IPsec)通訊協定

* 安全性比PPTP VPN高
* 驗證方法
  * 預先共用金鑰：應僅作為測試時使用
  * 憑證：安全性高
* 加密法：IPSec ESP的3DES或AES

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_3.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_4.png)

---

Windows Vista之前的版本支援的是DES與3DES

# SSTP通訊協定

* 採用HTTPS通訊協定\(HTTP over SSL\)
  * 安全性較高、只要在防火牆開放443即可、是企業普遍採用的通訊協定
  * PPTP與L2TP通訊協定所使用的連接埠複雜度較高，會增加防火牆設定的困難度

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_5.png)

# IKEv2通訊協定

* 採用 __IPsec__  __通道__  __模式__ \(UDP連接埠號碼500\)通訊協定
* 透過IKEv2 MOBIKE，讓行動使用者更方便透過VPN連接企業內部網路
* 網路中斷後，在一段時間內，VPN通道仍然保留著不會消失\(進入休眠狀態\)，一旦網路重新連線後，VPN通道就會自動恢復運作，使用者不需重新連線、應用程式可以好像沒有被中斷一樣的繼續運作
* IKEv2用戶端可以採用使用者驗證或電腦驗證方式來連接VPN伺服器
  * 使用者驗證：僅VPN伺服器需安裝電腦憑證；電腦驗證：VPN用戶端與伺服器都需安裝電腦憑證
  * VPN伺服器的電腦憑證應包含 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 憑證\(或僅包含 __伺服器驗證__ 亦可。若VPN伺服器內有多個內含 __伺服器驗證__ 的電腦憑證的話，則它會挑選同時包含 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 的電腦憑證\)
  * 用戶端的電腦憑證為 __用戶端驗證__ 憑證
* 若是站台對站台IKEv2 VPN的話，則它還支援採用 __預先共用金__  __鑰__ 的電腦驗證方法。若使用電腦憑證的話，則兩台VPN伺服器應安裝同時包含 __用戶端驗證__ 、 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 憑證的電腦憑證

---

L2TP使用IKEv1
例如車上使用筆記型電腦、使用者在客戶的辦公室之間遊走時

# PPTP VPN實例演練圖

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_6.png)

Active Directory網域:sayms\.local

DC1:網域控制站與DNS伺服器\(Windows Server 2016\)

VPNS1:VPN伺服器\(成員伺服器，Windows Server 2016\)

VPNC1:VPN用戶端\(未加入網域，Windows 10\)

安裝好作業系統、設定IP位址等

暫時關閉3台電腦的 __Windows__  __防火牆__ ，然後利用ping指令來確認DC1與VPNS1相互之間、VPNS1與VPNC1相互之間可以正常溝通

# 網域控制站的安裝與設定 - 1

* 兼具網域控制站、DNS伺服器、DHCP伺服器、WIN伺服器
* 網域控制站
  * VPN用戶端的使用者將利用網域使用者帳戶來連接VPN伺服器
  * 透過安裝 __Active __  __Directory__  __網域__  __服務__ 角色來建立AD DS網域
* DNS伺服器
  * 支援AD DS、對內部用戶端與VPN用戶端提供DNS名稱解析的服務

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_7.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_8.png)

* DHCP伺服器
  * 指派IP位址與DHCP選項設定給VPN用戶端
  * 建立網路識別碼為192\.168\.8\.0的領域
  * 父系網域名稱為sayms\.local、DNS伺服器IP位址為192\.168\.8\.1、WINS伺服器IP位址為192\.168\.8\.1、停用DHCPv6無狀態模式
  * 在虛擬環境之下，請將虛擬內部網路的DHCP停用，以避免衝突
* WIN伺服器
  * 讓VPN用戶端可以利用NetBIOS主機名稱來與內部主機溝通

# PPTP VPN伺服器

* 由 __路由及遠端存取服務__ \(RRAS\)來提供此功能
* RRAS啟動時會向DHCP伺服器租用10個IP位址供VPN用戶端使用，IP位址用完後再繼續租用10個IP位址…
  * 變更每次租用IP位址的數量\( __REG\_DWORD__ \)
  * __ __  __    HKEY\_LOCAL\_MACHINE\\SYSTEM\\__  __CurrentControlSet__  __\\Services\\__  __ __  __  	__  __RemoteAccess__  __\\Parameters\\IP\\__  __InitialAddressPoolSize__
* RRAS無法從DHCP伺服器取得選項設定，除非VPN伺服器本身也扮演 __DHCP__  __轉接代理__ 的角色
* 連線時可使用的本機使用者帳戶或AD DS網域帳戶
* 若使用AD DS網域帳戶
  * VPN伺服器有加入網域:直接透過DC的AD DS資料庫來驗證
    * VPN伺服器的電腦帳戶必須被加入到AD DS的 __RAS and IAS Servers__ 群組內
  * VPN伺服器未加入網域:需透過RADIUS

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_9.png)

# PPTP VPN伺服器實例演練 - 1

採用將VPN伺服器加入網域的方式

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_10.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_11.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_12.png)

讓此網路介面只接受與VPN有關的封包

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_13.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_14.png)

---

VPN伺服器的電腦帳戶需加入到Active Directory的RAS and IAS Servers群組，而且會在此時自動被加入，不過此時必須是利用網域Administrator身分登入，否則會跳出加入失敗的警告畫面（可在VPN伺服器架設完成後，自行到網域控制站上利用Active Directory使用者和電腦或Active Directory管理中心主控台手動將VPN伺服器的電腦帳戶加入到此群組）

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_15.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_16.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_17.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_18.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_19.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_20.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_21.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_22.png)

# 賦予使用者遠端存取的權利

預設是所有使用者帳戶都沒有連接VPN伺服器的權利，必須另行開放

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_23.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_24.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_25.jpg)

# PPTP VPN用戶端的設定 - 1

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_26.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_27.png)

* 實驗環境中直接將VPN用戶端與VPN伺服器連接在同一個網路區段上
* 按  \+I鍵網路和網際網路
  * 或按  \+ R鍵輸入control後按Enter鍵網路和網際網路網路和共用中心點擊 __設定新的連線或網路__ 點擊 __連線到工作地點__ …

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_28.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_29.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_30.png)

\* VPN類型選 __自動__ 時，系統挑選順序為IKEv2、SSTP、PPTP、L2TP，但目前只有PPTP可用（L2TP、SSTP與IKEv2還需其他設定）

---

用戶端目前沒有連上網際網路的話，則系統會問您是否要設定網際網路連線，此時請選擇我稍後再設定網際網路連線

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_31.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_32.png)

若VPN伺服器的Windows防火牆未啟用路由及遠端存取（PPTP\-In）與路由及遠端存取（GEP\-In）規則的話

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_33.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_34.png)

---

若VPN伺服器的Windows防火牆未啟用路由及遠端存取（PPTP-In）與路由及遠端存取（GEP-In）規則的話，會出現連線錯誤警示畫面

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_35.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_36.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_37.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_38.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_39.png)

\* 內部網路電腦的 __Windows__  __防火牆__ 需開放 __檔案及印表機__  __共用__ 。網域控制站DC1預設已經開放

---

內部網路的電腦必須在Windows防火牆開放檔案及印表機共用，否則上述溝通行為會被Windows防火牆阻擋，而網域控制站DC1預設已經開放

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_40.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_41.png)

# NetBIOS電腦名稱解析

* VPN用戶端\(節點類型為 __交互式__ \)可利用WINS與廣播來解析內部電腦的NetBIOS電腦名稱，例如\\\\DC1
* 若實驗環境中未架設WINS伺服器，則僅能使用廣播方式:
  * 需在VPN伺服器啟用廣播解析功能
  * 僅適用於單一網路：VPN用戶端與內部電腦的IP位址的網路識別碼需相同
  * 若IP位址為在VPN伺服器內靜態指定，且並非與內部網路同一個網路識別碼的話，則VPN用戶端將無法解析內部電腦的NetBIOS電腦名稱

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_42.png)

---

實驗環境中，內部電腦的網路識別碼為192.168.8.0，同時VPN用戶端透過DHCP伺服器所獲得的IP位址的網路識別碼也是192.168.8.0，故VPN用戶端可以透過廣播方式來解析到內部NetBIOS電腦名稱的IP位址，不需要WINS伺服器

# VPN用戶端為何無法上網 Part1 - 1

* 因為用戶端的VPN連線設定預設為 __使用遠端網路的預設閘道__
  * 點擊 __變更介面卡選項__ 對著VPN連線按右鍵內容點擊 __網路功能__ 標籤下的 __網際網路通訊協定第__  __4__  __版（__  __TCP/IPv4__  __）__ 點擊 __內容__ 鈕點擊 __進階__ 鈕

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_43.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_44.png)

* 連接VPN伺服器前的路由表
* 連接VPN伺服器後的路由表
  * 多了第2個預設閘道路徑，其計量值較低\(26\)
  * 當VPN用戶端要上網時，其封包會透過計量值較小的第2個路徑傳給VPN伺服器，而不是傳給可以上網的預設閘道192\.168\.1\.254\(計量值4506\)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_45.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_46.png)

* 取消勾選 __使用遠端網路的預設閘道__ 後的路由表
  * 除原預設閘道之外，還有一個內部網路路徑\(192\.168\.8\.0\)
  * VPN用戶端送往內部網路的封包，將透過此內部網路路徑送到VPN伺服器
  * VPN用戶端的上網封包會透過預設閘道來傳送
  * VPN用戶端能夠同時存取內部網路與網際網路，如此它可能會成為駭客攻擊內部網路的跳板，造成安全上的威脅

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_47.png)

* 若在VPN伺服器內指定靜態IP位址範圍，且其網路識別碼與內部網路不同
  * 例如網路識別碼為192\.168\.3\.0，而內部網路的網路識別碼為192\.168\.8\.0
  * 此時VPN用戶端連上VPN伺服器後，仍然只能夠與內部網路的電腦溝通，不能夠上網

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_48.png)

# VPN用戶端為何無法上網 Part2 - 2

若VPN用戶端勾選 __使用遠端網路的預設閘道__

  * 其路由表內並沒有一個送往內部網路\(192\.168\.8\.0\)的專有路徑，因此送往內部網路的封包將透過預設閘道
  * 圖中除原來的第1個預設閘道路徑\(192\.168\.1\.254，計量值為4506\)之外，又多了第2個預設閘道路徑\(其計量值為26\)
  * 當用戶端要連接內部電腦時，其封包會透過計量值較小的第2個路徑傳給VPN伺服器，因此可以正常的與內部電腦溝通
  * 當用戶端要上網時，其封包也會透過計量值較小的第2個路徑傳給VPN伺服器，而不是傳給可以上網的預設閘道192\.168\.1\.254，也就是VPN用戶端無法上網

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_49.png)

若VPN用戶端取消勾選 __使用遠端網路的預設閘道__ 的話，則VPN連線成功後，其路由表將如圖所示

圖中除了原預設閘道路徑\(192\.168\.1\.254\)外，並沒有送往內部網路\(192\.168\.8\.0\)的專有路徑，因此用戶端雖可透過預設閘道192\.168\.1\.254上網，但要與內部電腦溝通的封包也會被送往此預設閘道，而不是VPN伺服器，因而無法與內部主機溝通

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_50.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_51.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_52.png)

* 若要讓VPN用戶端能夠與內部電腦溝通
  * 自行在用戶端上建立一個送往內部網路\(192\.168\.8\.0\)的專有路徑
  * 需先找出此VPN連線中VPN伺服器的IP位址，如圖中VPN伺服器的IP位址為192\.168\.3\.1\(靜態IP位址範圍中的第1個IP位址\)
* __route  add  192\.168\.8\.0  mask  255\.255\.255\.0  __  __192\.168\.3\.1__

  * 此用戶端除了可透過此路徑來連接內部電腦，也可透過預設閘道上網，不過安全性較差，建議還是採用預設的 __使用遠端網路的預設閘道__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_53.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_54.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_55.png)

# L2TP VPN實例演練 – 預先共用金鑰(1)

沿用 __PPTP __  __VPN實例演練__ 的環境

VPN用戶端與伺服器兩端都設定相同的 __預先共用金鑰__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_56.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_57.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_58.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_59.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_60.png)

# L2TP VPN實例演練 – 電腦憑證

* 沿用 __PPTP __  __VPN實例演練__ 的環境
* VPN伺服器與用戶端都需要申請與安裝電腦憑證
  * 圖中的電腦DC1上另外安裝了企業根CA
  * 同時也安裝了IIS網站，以便可以利用瀏覽器來向此企業根CA申請憑證
* 建立初始測試環境
  * 與PPTP VPN相同，請先建立PPTP VPN並測試是否可以正常成功連線
* 安裝企業根CA：在DC1上新增 __Active Directory__  __憑證服務__ \(AD CS\)角色

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_61.png)

# L2TP VPN伺服器的設定

* 信任CA
  * 隸屬於網域的VPN伺服器會自動信任企業CA
    * 執行 __gpupdate__  __ /force__
* 替VPN伺服器申請憑證
* 將憑證搬移到電腦憑證存放區

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_62.png)

# 替L2TP VPN伺服器申請憑證 - 1

L2TP VPN伺服器需要 __伺服器驗證__ 電腦憑證，而企業根CA的“ __電腦__ ”憑證範本內含 __伺服器驗證__ 憑證，故我們可以透過申請“ __電腦__ ”憑證範本來擁有 __伺服器__  __驗證__ 憑證

透過 __憑證__  __ __  __MMC__ 嵌入式管理單元來申請

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_63.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_64.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_65.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_66.png)

完成後，請重新啟動 __路由及遠端存取服務__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_67.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_68.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_69.png)

# L2TP VPN用戶端的設定

VPN用戶端位於外部網路，它目前並無法連接到內部的企業根CA，因此它要如何來向企業根CA申請憑證與執行信任CA的步驟呢?

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_70.png)

# 用戶端信任CA與申請憑證的方法

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_71.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_72.png)

* 直接將CA與VPN伺服器的憑證檔案拿到VPN用戶端匯入
  * 到VPN伺服器上透過 __憑證__ 主控台，從電腦憑證存放區將CA的憑證與VPN伺服器的電腦憑證\(需含私密金鑰\) 匯出存檔\(其副檔名分別是\.cer與\. pfx\)
  * 將憑證檔拿到VPN用戶端上利用 __憑證__ 主控台將它們分別匯入到電腦憑證存放區的 __受__  __信任的根憑證授權__  __單位__ 與 __個人__
* VPN用戶端利用PPTP連上VPN伺服器，就可連接內部企業根CA網站
* 在VPN伺服器上啟用NAT，然後透過連接埠對應將HTTP流量轉到內部企業根CA網站，用戶端就可以來連接內部企業根CA網站
* 將VPN用戶端暫時搬到內部網路（需變更IP設定），就可以來連接內部企業根CA網站。待完成信任CA、申請與安裝電腦憑證等工作後再將VPN用戶端搬回外部網路

# 用戶端利用Microsoft Edge瀏覽器申請憑證

* 並未加入網域的VPN用戶端，需利用瀏覽器來連接CA網站與申請憑證，無法使用 __憑證__ 管理主控制台
* 申請憑證的方法
  * 利用https方式來連接CA網站，但需將CA網站加入到 __信任的__  __網站__
  * 利用http方式來連接CA網站，但請暫時將 __近__  __端內部網路__ 的安全性等級降為 __低__ 等級，同時將CA網站加入到 __近端內部__  __網路__
* 利用Microsoft Edge瀏覽器申請憑證的方法之前已經介紹過

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_73.png)

所申請的憑證是被儲存到 __使用者憑證存放區__ ，我們需將此憑證從 __使用者憑證存放區__ 匯出、再將其匯入到 __本機電腦憑證存放區__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_74.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_75.png)

# 測試L2TP VPN連線 - 1

沿用前面的PPTP VPN連線，只作小幅度修改即可

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_76.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_77.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_78.png)

若要進一步驗證VPN伺服器的電腦憑證的話，可以在VPN用戶端利用 __憑證__ 主控台將此憑證刪除、或將CA的憑證刪除，此時重新利用VPN連線時會失敗

# SSTP VPN實例演練

* 初始環境與 __PPTP __  __VPN實例演練__ 類似，但還需執行兩個變更工作
  * 因VPN伺服器需申請與安裝憑證，故我們在圖中DC1上另外安裝了企業根CA與IIS網站。SSTP VPN用戶端不需要憑證
  * VPN用戶端在建立SSTP VPN之前，需利用HTTP來從CA下載 __憑證撤銷清單__ \(CRL\)，否則VPN連線會失敗：在VPN伺服器啟用NAT、透過連接埠對應功能將HTTP流量轉到內部企業根CA網站

若還未建立PPTP VPN的話，請先依照前面 __PPTP VPN__  __實例演練__ 的說明來完成環境的建置，並測試PPTP VPN是否可以成功連線

安裝企業根CA：在DC1上新增 __Active Directory__  __憑證服務__ \(AD CS\)角色

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_79.png)

# 在企業CA指定CRL發佈點 - 1

* VPN用戶端在建立SSTP VPN之前，需從CA下載CRL\(憑證撤銷清單\)
  * 透過 __CRL__  __發佈__  __點__ ：LDAP路徑、FILE路徑、HTTP路徑\(以下採用此方法\)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_80.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_81.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_82.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_83.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_84.png)

若http路徑的 __CDP__  __位置__ 或 __DeltaCRL__  __位置__ 有短少的話

# SSTP VPN伺服器的設定

啟用VPN伺服器的NAT功能

開放所需的流量

信任CA

替SSTP VPN伺服器申請電腦憑證

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_85.png)

# 啟用VPN伺服器的NAT功能 - 1

* 讓VPN用戶端可以從企業根CA網站下載CRL
  * 將VPN伺服器設定為NAT伺服器
  * 透過NAT的連接埠對應功能將VPN用戶端的HTTP流量轉到內部企業根CA網站

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_86.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_87.png)

---

也可以在建立PPTP VPN環境時，將VPN伺服器同時設定為NAT伺服器(選擇虛擬私人網路 (VPN)存取和NAT)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_88.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_89.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_90.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_91.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_92.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_93.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_94.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_95.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_96.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_97.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_98.png)

# 開放所需的流量

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_99.png)

VPN伺服器預設會透過 __靜態封包篩選器__ 來讓外網卡只接受與VPN有關的封包，因此用戶端要從企業CA網站的 __CRL__  __發佈點__ 來下載CRL的HTTP流量會被封鎖

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_100.png)

---

因架設PPTP VPN伺服器此用預設值：勾選了設定靜態封包篩選器來啟用選擇介面的安全性。
若只要開放HTTP流量的話，請在點擊輸入篩選器鈕後按新增鈕，然後在通訊協定處選TCP、目的地連接埠輸入80，其他選項採用預設值

# 信任CA

* 隸屬於網域的VPN伺服器會自動信任企業根CA
* 驗證VPN伺服器是否已經信任此企業根CA
  * 按 \+R鍵輸入control後按Enter鍵網路和網際網路網際網路選項 __內容__ 標籤點擊 __憑證__ 鈕 __受信任的根憑證授權單位__ 標籤
  * 也可以透過 __憑證__ 管理主控台的 __電腦__ 憑證存放區來查看

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_101.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_102.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_103.png)

# 透過憑證主控台來申請電腦憑證

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_104.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_105.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_106.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_107.png)

VPN用戶端在連接SSTP VPN伺服器時需透過此名稱來連線

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_108.png)

---

若您需要匯出私密金鑰的話，請透過點擊右方詳細資料圖示來設定

# SSTP VPN用戶端的設定

* 用戶端可以是Windows 10 、Windows 8\.1\(8\)、Windows 7或Windows Vista Service Pack 1、Windows Server 2016、Windows Server 2012\(R2\)、Windows Server 2008\(R2\)
* SSTP VPN用戶端需要信任CA
  * 將安裝在VPN伺服器的CA憑證匯出存檔，再拿到VPN用戶端上匯入
* VPN用戶端需使用vpns1\.sayms\.local來連接VPN伺服器時
* VPN用戶端需從 __CRL__  __發佈點__ 來下載CRL

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_109.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_110.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_111.png)

# 名稱解析的問題

* VPN用戶端透過vpns1\.sayms\.local連接SSTP VPN伺服器時需將vpns1\.sayms\.local解析到VPN伺服器外網卡的IP位址192\.168\.1\.200
  * VPN用戶端連接伺服器時，需從 __CRL__  __發佈__  __點__ \(http://dc1\.sayms\.local/\.\.\.\)來下載CRL
  * 需將dc1\.sayms\.local解析到VPN伺服器外網卡的IP位址192\.168\.1\.200

應透過DNS伺服器，但本實驗採用hosts檔

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_112.png)

---

Windows 8.1用戶端需系統管理員才有權利變更hosts檔案

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_113.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_114.png)

# 測試SSTP  VPN連線 - 1

沿用前面的PPTP VPN連線，只作小幅度的修改即可

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_115.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_116.png)

由於是透過hosts檔案來將dc1\.sayms\.local解析到192\.168\.1\.200，故此時將無法利用dc1\.sayms\.local來與網域控制站DC1溝通，因為DC1的IP位址為192\.168\.8\.1。若要解決此問題的話，可以透過新增HTTP路徑（並刪除原HTTP路徑），並將此新路徑中的<ServerDNSName>改為自訂的DNS名稱，例如CA\.sayms\.local，然後在DNS伺服器或VPN用戶端的Hosts內將CA\.sayms\.local的IP位址設定為192\.168\.1\.200

---

由於我們是透過hosts檔案來將dc1.sayms.local解析到192.168.1.200，故此時將無法利用dc1.sayms.local來與網域控制站DC1溝通，因為dc1.sayms.local的IP位址為192.168.8.1

若VPN主機名稱\(vpns1\.sayms\.local\)錯誤的話

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_117.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_118.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_119.png)

# IKEv2 VPN實例演練 – 使用者驗證

* 沿用 __PPTP __  __VPN__  __實例演練__ 環境，請先建立PPTP VPN
* IKEv2 VPN伺服器需安裝電腦憑證
  * 圖中電腦DC1上另外安裝了企業根CA，同時也安裝了IIS網站
  * IKEv2 VPN伺服器的電腦憑證應包含 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 憑證（也可以僅包含 __伺服器驗證__ 憑證）
    * 在企業根CA內並無任何憑證範本同時包含這兩個憑證，因此需要自行建立新的憑證範本

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_120.png)

  * IKEv2 VPN用戶端不需要下載CRL，且採用使用者驗證時，用戶端不需要申請與安裝憑證

安裝企業根CA：在DC1上新增 __Active Directory__  __憑證服務__ \(AD CS\)角色

# 建立新憑證範本 - 1

包含 __伺服器__  __驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 憑證

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_121.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_122.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_123.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_124.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_125.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_126.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_127.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_128.png)

# 建立新憑證範本 - 2

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_129.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_130.png)

# 建立新憑證範本 - 3

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_131.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_132.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_133.png)

# IKEv2 VPN伺服器的設定

* 信任CA
  * 隸屬於網域的VPN伺服器VPNS1已經信任此企業根CA

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_134.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_135.png)

# 替IKEv2 VPN伺服器申請電腦憑證

* VPN伺服器需要安裝 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 電腦憑證
  * 向企業根CA申請自建的 __IKEv2 __  __VPN__ 憑證範本
* 需重新啟動 __路由及遠端存取__  __服務__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_136.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_137.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_138.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_139.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_140.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_141.png)

# IKEv2 VPN用戶端的設定 - 1

* IKEv2 VPN用戶端可以是Windows 10、Windows 8\.1\(8\)、Windows 7、Windows Server 2016、Windows Server 2012\(R2\)、Windows Server 2008 R2
* IKEv2 VPN用戶端需要信任CA
  * 將安裝在VPN伺服器的CA憑證匯出存檔，再拿到VPN用戶端上匯入

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_142.png)

* VPN用戶端需使用vpns1\.sayms\.local來連接VPN伺服器
  * 需將vpns1\.sayms\.local解析到VPN伺服器外網卡的IP位址
  * 應透過DNS伺服器，但本實驗採用hosts檔

* VPN用戶端需使用vpns1\.sayms\.local來連接VPN伺服器
  * 需將vpns1\.sayms\.local解析到VPN伺服器外網卡的IP位址
  * 應透過DNS伺服器，但本實驗採用hosts檔

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_143.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_144.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_145.png)

# 測試IKEv2 VPN連線 - 1

沿用前面的PPTP VPN連線，只要做小幅度的修改

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_146.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_147.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_148.png)

# 測試IKEv2 VPN的行動功能 - 1

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_149.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_150.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_151.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_152.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_153.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_154.png)

* 若實體連線未在30分鐘內重新連線的話，VPN連線就會被中斷
  * 某些版本的Windows10會在網路中斷60秒後，自動中斷IKEv2 VPN連線\(請上網更新Windows10來解決此問題\)

若IKEv2 VPN伺服器未安裝正確的電腦憑證或未信任CA

若VPN連線的VPN主機名稱設定錯誤或VPN用戶端並未信任CA

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_155.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_156.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_157.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_158.png)

# IKEv2 VPN實例演練 – 電腦驗證

* VPN伺服器需要安裝 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 電腦憑證之外（或僅包含 __伺服器驗證__ 憑證亦可）
  * 信任CA、申請與安裝電腦憑證等前一個實驗已經完成
  * 勾選 __允許__  __IKEv2__  __的電腦憑證__  __驗證__ 後，需重新啟動 __路由及遠端存取服務__
* 用戶端也需要安裝 __用戶端驗證__ 電腦憑證

# IKEv2 VPN用戶端的設定 - 1

* VPN用戶端需信任CA\(前一個章節已完成\)、申請與安裝電腦憑證
* 並未加入網域的VPN用戶端，需利用瀏覽器來連接CA網站與申請憑證，無法使用 __憑證__ 管理主控制台
* 申請憑證的方法
  * 利用https方式來連接CA網站，但需將CA網站加入到 __信任的__  __網站__
  * 利用http方式來連接CA網站，但請暫時將 __近__  __端內部網路__ 的安全性等級降為 __低__ 等級，同時將CA網站加入到 __近端內部__  __網路__
* 利用Microsoft Edge瀏覽器申請憑證的方法之前已經介紹過

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_159.png)

所申請的憑證是被儲存到 __使用者憑證存放區__ ，我們需將此憑證從 __使用者憑證存放區__ 匯出、再將其匯入到 __本機電腦憑證存放區__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_160.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_161.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_162.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_163.png)

到VPN用戶端將驗證方式改為電腦憑證

\*若無法儲存設定，或設定值跑掉，請改透過【點擊VPN畫面下方的 __變更介面卡選項__ 對著VPN連線按右鍵內容 __安全性__ 標籤然後如圖所示來設定即可解決此問題

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_164.png)

由於是採用電腦憑證驗證方式，故使用者不需輸入使用者帳戶與密碼

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_165.png)

\* 即使已經連線成功，但若Windows 10並未在VPN畫面上顯示 __已連線__ 的話，此時也沒有中斷連線鈕供使用。此時若要中斷連線的話，可透過點擊 __變更介面卡選項__ 雙擊VPN連線點擊 __中斷連線__ 鈕

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_166.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_167.png)

# 站台對站台PPTP VPN實例演練

兩台VPN伺服器透過外網卡直接連接在同一個網路區段上

將每一台電腦的作業系統安裝完成、IP位址等依照圖所示設定完成

暫時關閉圖中4台電腦的 __Windows__  __防火牆__ ，然後利用ping指令來確認同網路的電腦相互之間可以正常溝通，完成後再重新啟動 __Windows__  __防火牆__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_168.png)

# 指定撥號

* 指定撥號介面
  * A2B
    * 當A網路內的用戶端需要與B網路內的用戶端溝通時，此溝通封包傳送到VPNS1時，VPNS1就會自動透過指定撥號介面A2B來與VPNS2建立VPN連線
  * B2A

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_169.png)

使用者帳戶可以是VPN伺服器的本機使用者帳戶或Active Directory使用者帳戶

* VPN伺服器透過指定撥號連接對方時，需提供有效的使用者名稱與密碼，此使用者名稱必須與對方的指定撥號介面名稱相同
  * VPNS1撥接VPNS2
    * 使用者帳戶名稱為B2A
  * VPNS2撥接VPNS1
    * 使用者帳戶名稱為A2B

# 使用者帳戶

* 若是VPN伺服器的本機使用者帳戶
  * 則直接由VPN伺服器透過本機使用者帳戶資料庫來驗證使用者名稱與密碼
* 若使用Active Directory使用者帳戶
  * 若VPN伺服器有加入網域
    * 則VPN伺服器會透過網域控制站的Active Directory資料庫來驗證使用者身份
  * 若VPN伺服器未加入網域
    * 則需要透過RADIUS機制來驗證使用者身份

# A網路VPN伺服器的設定 - 1

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_170.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_171.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_172.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_173.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_174.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_175.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_176.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_177.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_178.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_179.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_180.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_181.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_182.jpg)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_183.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_184.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_185.png)

若 __Windows__  __防火牆__ 的輸入規則 __路由及遠端存取__  __\(PPTP\-In\)__ 與 __路由及遠端存取__  __\(GEP\-In\)__ 尚未啟用的話，請啟用

---

遠端VPN伺服器VPNS2必須使用這個以介面名稱命名的使用者名稱A2B來連接VPNS1，若改用其他使用者名稱的話，連線會失敗
變更目的地的主機名稱或IP位址、閒置多久自動將指定撥號連線斷線（預設為5分鐘）、選擇VPN通訊協定等：對著指定撥號介面A2B按右鍵內容

# B網路VPN伺服器的設定

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_186.png)

B網路VPN伺服器VPNS2的設定方式與VPNS1相同，但有幾個步驟要稍加修改

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_187.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_188.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_189.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_190.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_191.png)

# 測試指定撥號功能是否正常

* 在A網路的Server1上 __ping __ B網路的Win10PC1\(或反向測試\)
  * 暫時關閉Win10PC1的 __Windows__  __防火牆__
* 可手動中斷連線。也可利用手動連線來判斷無法連線的可能原因
* 指定撥號篩選器與撥出時數

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_192.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_193.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_194.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_195.png)

# 設定指定撥號篩選器與撥出時數

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_196.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_197.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_198.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_199.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_200.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_201.png)

# 支援VPN用戶端 - 1

讓站台對站台VPN伺服器也同時支援VPN用戶端

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_202.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_203.png)

# 支援VPN用戶端 - 2

賦予使用者撥入權限、設定適當的IP位址

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_204.png)

# 站台對站台L2TP VPN－預先共用金鑰

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_205.png)

* 只建議使用在測試環境，不建議使用在正式環境中
* 建立初始測試環境
  * 與 __站台對站台PPTP__  __ __  __VPN實例演練__ 類似
  * 還需另外在兩台VPN伺服器都設定相同的 __預先共用金鑰__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_206.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_207.png)

# 由VPNS1來啟始連線到VPNS2

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_208.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_209.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_210.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_211.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_212.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_213.png)

# 由VPNS2來啟始連線到VPNS1

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_214.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_215.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_216.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_217.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_218.png)

# 利用瀏覽器申請電腦憑證

* VPN伺服器所需的電腦憑證
  * L2TP VPN伺服器： __伺服器__  __驗證__ 憑證或 __用戶端驗證__ 憑證
  * SSTP VPN伺服器： __伺服器__  __驗證__ 憑證
  * IKEv2 VPN伺服器：需安裝同時包含 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 憑證的電腦憑證（或僅安裝 __伺服器驗證__ 憑證亦可），若是站台對站台VPN的話，則兩台伺服器都需要安裝同時包含 __用戶端驗證__ 、 __伺服器驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 憑證的電腦憑證

# 申請電腦憑證的方法

* 利用 __憑證__ 管理主控台向企業CA申請
  * 透過申請“ __電腦__ ”憑證範本來擁有 __伺服器驗證__ 憑證
  * IKEv2 VPN伺服器透過申請自建的新憑證範本 __IKEv2 VPN__ ，便可擁有 __伺服器__  __驗證__ 與 __IP__  __安全性__  __IKE__  __中繼__ 憑證
    * 若是站台對站台VPN的話，還需增加 __用戶端__  __驗證__
* 利用瀏覽器來向CA申請憑證
  * 企業CA
    * L2TP VPN伺服器可申請 __系統管理員__ 範本\(內含 __用戶__  __端驗證__ 憑證\)
    * 建立一個內含 __伺服器驗證__ 憑證的新憑證範本，以便讓L2TP與SSTP VPN伺服器都可以來申請此憑證。建議此範本同時也包含 __IP__  __安全性__  __IKE__  __中繼__ 憑證，讓IKEv2 VPN伺服器也可以來申請此憑證範本
  * 獨立CA
    * 獨立CA內已經有 __伺服器驗證__ 憑證可供申請

---

在企業CA已經發行的憑證範本中，預設並沒有內含伺服器驗證憑證、且適合於VPN伺服器、且可以利用瀏覽器來申請的憑證範本

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_219.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_220.png)

# 利用瀏覽器申請電腦憑證 - 1

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_221.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_222.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_223.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_224.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_225.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_226.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_227.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_228.png)

# 將憑證搬移到電腦憑證存放區 - 1

所申請的電腦憑證會被自動安裝到使用者憑證存放區，然而它必須被安裝到電腦憑證存放區才有效

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_229.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_230.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_231.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_232.png)

完成後重新啟動 __路由及遠端存取__ 服務

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_233.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_234.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_235.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_236.png)

# 網路原則

限制使用者被允許連線的時間

限制只有屬於某個群組的使用者，才可以連接遠端存取伺服器

限制使用者必須透過指定的方式來連線，例如VPN

限制使用者必須使用指定的驗證通訊協定、資料加密方法

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_237.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_238.png)

# 網路原則基本概念 - 1

* 透過網路原則伺服器\(NPS\)來檢視與設定網路原則
* 2個內建的網路原則，排列在越上面的原則優先權越高
* 使用者連接RAS時，RAS會將此連線要求轉給NPS來檢查，而NPS會先從最上面的原則開始比對使用者是否符合該原則內所定義的條件
  * 若符合：以此原則內的設定來決定使用者是否可以RAS
  * 若不符合：依序比對後面的原則
    * 若沒有任何一個原則符合的話，使用者會被拒絕連接RAS

# 網路原則基本概念 - 2

* 一般使用者會符合圖中第1個原則 __連線到__  __Microsoft__  __路由和遠端存取伺服器__ 的條件
  * 此原則會拒絕所有使用者來連線
  * 並不是單純的只以網路原則來決定，其判斷流程請參考最後的流程圖
* 第1個原則：是以使用者在本機使用者資料庫或Active Directory資料庫內的撥入權限來決定

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_239.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_240.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_241.png)

# 新增網路原則 - 1

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_242.png)

* 假設要在此原則內設定以下條件
  * 利用VPN來連接的使用者
  * 隸屬於網域SAYMS內業務部群組
* 假設在這個原則內設定兩個限制
  * 只允許在星期一到星期五早上6:00－下午10:00之間來連線
  * 僅限使用MS\-CHAP v2驗證方法
* 只接受VPN用戶端以加密方式來傳送資料

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_243.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_244.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_245.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_246.png)

# 新增網路原則 - 2

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_247.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_248.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_249.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_250.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_251.png)

# 新增網路原則 - 3

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_252.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_253.png)

# 是否接受連線的詳細流程 - 1

使用者是否被允許連接遠端存取伺服器，是同時由使用者帳戶內容與網路原則的設定來決定

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_254.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_255.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_256.png)

註3:若非 __拒絕存取__ ，也非 __允許存取__ ，那就是 __透過__  __NPS__  __網路原則控制存取__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_257.png)

註5:例如透過電話網路來連接遠端存取伺服器的話，則我們可以限定使用者端的電話號碼

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_258.png)

* 若在網路原則內針對使用者的連線設定了某些限制，例如:
  * 限制使用者被允許連線的時間
  * 限制使用者只能夠透過指定的連接埠類型\(例如VPN\)來連接

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch10-%E8%99%9B%E6%93%AC%E7%A7%81%E4%BA%BA%E7%B6%B2%E8%B7%AF%28VPN%29_259.png)

