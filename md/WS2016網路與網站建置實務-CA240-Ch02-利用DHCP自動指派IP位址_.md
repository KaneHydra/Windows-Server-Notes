第 2 章 利用DHCP自動指派IP位址

2\-1 主機IP位址的設定

2\-2 DHCP的運作原理

2\-3 DHCP伺服器的授權

2\-4 DHCP伺服器的安裝與測試

2\-5 IP領域的管理

2\-6 DHCP的選項設定

2\-7 DHCP轉送代理

2\-8 超級領域與多點傳送領域

2\-9 DHCP資料庫的維護

2\-10 監視DHCP伺服器的運作

2\-11 IPv6位址與DHCPv6的設定

2\-12 DHCP容錯移轉

# 主機IP位址的設定

* 手動輸入
  * 容易出錯而影響到主機的網路溝通能力或干擾到其他主機的運作，因此會加重系統管理員的負擔
* 自動向DHCP伺服器索取
  * 由使用者的電腦自動向DHCP伺服器索取
  * 可減輕管理上的負擔
  * 減少手動輸入錯誤所造成的困擾

# DHCP基本架構

* DHCP伺服器與DHCP用戶端
  * 網路內至少需有一台啟動DHCP服務的伺服器
  * 用戶端需將IP位址設定為自動索取
* DHCP伺服器將IP位址出租給DHCP用戶端一段時間，租約到期前若用戶端沒有更新租約的話，會收回該IP位址的使用權

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_0.png)

* 手動輸入的IP位址
  * 靜態IP位址
* 向DHCP伺服器租用的IP位址
  * 動態IP位址
* 選項設定：例如預設閘道、DNS伺服器的IP位址等

# 向DHCP伺服器索取新IP位址

用戶端電腦第一次扮演DHCP用戶端的角色

用戶端所租用的IP位址已被DHCP伺服器收回且已租給別台電腦

用戶端釋放所租用的IP位址\(且此IP位址又已租給其他用戶端\)，並要求重新租用IP位址

用戶端電腦更換了網路卡

用戶端電腦被搬移到另外一個網路

# 索取新IP位址的流程

* DHCPDISCOVER
* DHCPOFFER
* DHCPREQUEST
  * 利用此廣播封包通知被選上的、未被選上的DHCP伺服器
  * 送出DHCPDECLINE訊息：若用戶端透過ARP發現此IP位址已被使用中
* DHCPACK
  * 包含用戶端所需的相關設定，例如IP位址、子網路遮罩、預設閘道、DNS伺服器等

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_1.png)

---

通知沒有被選上的DHCP伺服器(DHCPREQUEST)：以便它們將原本欲分配給此用戶端而保留的IP位址，釋放出來供其它用戶端使用
DHCPACK：之所以用廣播方式，是因為此時DHCP用戶端還是尚未有IP位址

# 更新IP位址的租約

* 更新租約成功
  * DHCP伺服器回應DHCPACK訊息。用戶端會重新取得一個新租約\(期限視當時DHCP伺服器的設定而定\)
* 更新租約失敗
  * 例如此位址已無效或已被其他電腦使用，此時DHCP伺服器會回應一個DHCPNAK訊息

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_2.png)

# 自動更新租約

* 用戶端電腦重新啟動時
  * 送出DHCPREQUEST廣播訊息
  * 若更新失敗，則嘗試與預設閘道溝通:
    * 溝通成功且租約並未到期：可繼續使用原IP位址，並等待下一次更新時間到達
    * 若無法溝通成功：放棄原IP位址，改用169\.254\.0\.0的IP位址，然後每隔5分鐘再更新
* 租約期過一半時
  * 自動送DHCPREQUEST的 __直接__ 訊息給出租此IP位址的DHCP伺服器
* 租約期過7/8時
  * 若租約過一半時更新失敗的話，仍可繼續使用原IP位址，但會在租約期過7/8時，再利用DHCPREQUEST __廣播__ 訊息來嘗試向任何一台DHCP伺服器更新租約。若仍無法更新成功，則放棄原IP位址，然後利用DHCPDISCOVER訊息重新索取新IP位址

# 手動更新租約與釋放IP位址

* ipconfig  /renew
* ipconfig  /release
  * 送DHCPRELEASE訊息給伺服器
  * 每隔5分鐘自動再租用IP位址
    * 也可執行ipconfig /renew

# APIPA私人IP位址

* 若用戶端電腦因故無法取得IP位址的話
  * 會透過Automatic Private IP Addressing的機制來替自己設定169\.254\.0\.0的臨時IP位址
    * 用戶端會先送出廣播訊息來便檢查此IP位址是否已被佔用
  * 可以與同一個網路內使用169\.254\.0\.0/16位址的電腦溝通
  * 仍然會每隔5分鐘尋找DHCP伺服器、租用IP位址

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_3.png)

---

若IP位址是手動設定，但卻被佔用的話，則也會使用169.254.0.0/16格式的IP位址。同樣的它也會與預設閘道溝通…

# DHCP伺服器的授權 - 1

* 未經過授權的DHCP伺服器不會出租IP位址給用戶端
  * 避免隨意安裝的DHCP伺服器出租不適當的IP位址給用戶端
* 必須建置Active Directory網域
  * 隸屬於AD DS網域的DHCP伺服器都必須被授權
  * DHCP伺服器啟動時，若透過AD資料庫得知其IP位址已登記在授權清單內的話，便可正常啟動與出租IP位址
* Enterprise Admins的成員才有權利執行授權動作

* 獨立伺服器無法被授權，其在啟動DHCP服務時，會送出DHCPINFORM廣播封包：
  * 若收到由已被授權的DHCP伺服器傳回的DHCPACK封包的話，則此獨立伺服器不會啟動DHCP服務
  * 若未收到DHCPACK封包或只是收到其他獨立DHCP伺服器所傳回的DHCPACK封包的話，則它會正常啟動DHCP服務
* AD DS環境
  * 建議第1台DHCP伺服器最好是成員伺服器或網域控制站，否則一旦之後在同一個子網路內有網域成員的授權DHCP伺服器上線後，則獨立伺服器的DHCP服務將無法再啟動
* Windows系統的DHCP伺服器可以被授權
  * Windows NT 4\.0或更舊版本的 DHCP伺服器、其他廠商所開發的DHCP伺服器無法被授權

---

DHCPINFORM廣播封包：檢查同一個子網路內是否有已被授權的DHCP伺服器

# DHCP伺服器的安裝與測試

* 安裝圖中各電腦的作業系統、設定TCP/IP、建立網域\(網域名稱sayms\.local\)、將DHCP電腦加入網域、Win10PC不需加入網域
* 先將網路上其他DHCP伺服器關閉
  * 例如Hyper\-V虛擬網路的DHCP、 IP分享器或寬頻路由器內的DHCP伺服器

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_4.png)

---

若要簡化測試環境的話，可以將圖中的DHCP電腦撤掉，改為直接將DHCP伺服器安裝到網域控制站DC

# 安裝DHCP伺服器角色

* DHCP伺服器採用靜態IP位址設定
* 事先規劃好要出租給用戶端電腦的IP位址領域
  * 假設是 192\.168\.8\.10 \- 192\.168\.8\.200
* 透過 __伺服器__  __管理員__ 的 __新增__  __角色及功能__ 來安裝DHCP伺服器
  * 利用網域Administrator登入

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_5.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_6.png)

---

透過伺服器管理員來安裝角色服務時，內建的Windows防火牆會自動開放與該服務有關的流量，例如此處會自動開放與DHCP有關的流量

# DHCP伺服器的授權設定

* DHCP伺服器的授權\(若尚未授權的話\)
  * 點擊左下角 __開始__ 圖示  Windows系統管理工具DHCP
* 也可以透過 __Active Directory__  __站台及服務__ 來查看被授權的DHCP伺服器清單
  * 點擊 __Active __  __Directory__  __站台及服務__ 文字 __檢視__ 功能表顯示服務節點展開 __Services__ 點擊 __NetServices__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_7.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_8.png)

# 建立IP領域

DHCP伺服器可以從這些領域內，選取一個尚未出租的適當IP位址，然後將其出租給用戶端

對著該領域按右鍵啟用\(若尚未啟用的話\)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_9.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_10.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_11.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_12.png)

# 測試用戶端是否可租到IP位址

先確認用戶端電腦的IP位址為自動取得

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_13.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_14.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_15.png)

# 利用ipconfig來檢查

* 可以利用ipconfig或ipconfig /all來查看
* 可利用ipconfig  /renew來測試IP租約的更新
* ipconfig  /release
  * 自動：每隔5分鐘重新送出租用要求
  * 手動：ipconfig /renew

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_16.png)

# 用戶端的其他設定

* 用戶端無法租到IP位址時
  * 自動私人IP位址\(預設值\)
    * APIPA\(169\.254\.0\.0/16\)
  * 使用者設定
    * 使用此處所設定的IP位址值。適合於用戶端電腦需要在不同網路中使用的場合

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_17.png)

---

例如筆記型電腦在公司是向DHCP伺服器租用IP位址，但當電腦拿回家裡使用時，由於家裡沒有 DHCP伺服器，因此就自動改用此處所設定的IP位址

# 一個子網路只可以建立一個IP領域

* 例如不可以建立以下的兩個領域
  * 192\.168\.8\.10   – 192\.168\.8\.200、子網路遮罩255\.255\.255\.0
  * 192\.168\.8\.210 – 192\.168\.8\.240、子網路遮罩255\.255\.255\.0

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_18.png)

---

本機Administrators與DHCP Administrators群組成員可以管理DHCP伺服器，例如新增/修改領域、修改設定等
本機DHCP Users群組內的成員也可以檢視DHCP伺服器內的資料庫與設定，但是無權修改設定

# 一個子網路不連續的多段IP範圍

* 例如可透過排除範圍的方式來建立以下的兩個領域
  * 192\.168\.8\.10–192\.168\.8\.200、子網路遮罩255\.255\.255\.0
  * 192\.168\.8\.210–192\.168\.8\.240 、子網路遮罩255\.255\.255\.0
* 先建立192\.168\.8\.10   － 192\.168\.8\.240的領域
  * 再排除192\.168\.8\.201 － 192\.168\.8\.209

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_19.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_20.png)

# IP位址衝突偵測

* DHCP伺服器可偵測欲出租的IP位址是否已被佔用
  * 偵測動作會影響伺服器的運作效率，故偵測次數不要太多\(1次即可，預設值為0次\)
  * 建議在網路上有比較舊的用戶端系統，同時您也懷疑有IP位址重複的問題時才啟用此功能

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_21.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_22.png)

# 租期該設定多久

* 租期設得較短
  * 用戶端更新租約頻率增加，會增加網路負擔
  * 較快取得伺服器端的新設定值
* 租期設得較長
  * 可降低網路負擔
  * IP位址不用時，若租約未到期，IP位址無法給其他的電腦使用
  * 需等較久時間才會取伺服器端的最新設定值
* 沒有限制
  * 若用戶端電腦從網路中移除或搬到其他網路時，其所租用的IP位址並不會自動被DHCP收回，需由系統管理員手動將此IP位址從位址租用區內刪除
  * 僅可利用重新開機時自動更新租約，或 ipconfig /renew手動更新租約的方式來取得伺服器的新設定值

# 建立多個IP領域

在一台DHCP伺服器內建立多個IP領域來對多個子網路內的DHCP用戶端提供服務

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_23.png)

# DCHP伺服器如何選擇領域

* 右邊用戶端傳來的租用IP封包
  * 路由器會在此封包的GIADDR欄位填入IP位址192\.168\.9\.254後傳給DHCP伺服器
  * 伺服器可透過此IP位址得知用戶端是位於192\.168\.9\.0的網路區段
* 左邊用戶端傳來的租用IP封包
  * 此封包是直接由DHCP伺服器來接收，故封包內的GIADDR欄位中的IP位址並未變更\(0\.0\.0\.0\)
  * 伺服器透過此IP位址便可得知用戶端是位於同一個網路區段\(192\.168\.8\.0\)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_24.png)

---

除了GIADDR之外，有些網路環境，其路由器還需要使用DHCP option 82內的更多資訊來判斷該出租什麼IP位址給用戶端

# 保留特定IP位址給用戶端

* 伺服器會將保留的IP位址出租給指定的用戶端
  * MAC位址
    * 可透過TCP/IP設定或IPCONFIG /ALL指令來查詢
  * 支援類型
    * 用來選擇欲支援的用戶端\(DHCP或較舊的BOOTP用戶端\)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_25.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_26.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_27.png)

---

支援類型：用來選擇欲支援的用戶端(DHCP或較舊的BOOTP用戶端)

# 篩選用戶端電腦

* 用來允許或拒絕將IP位址出租給指定的用戶端電腦
* 預設的 __允許__ 或 __拒絕__ 篩選器都是停用
  * 若僅將 __允許__ 或 __拒絕__ 類別篩選器啟用的話，則只有列於此處的用戶端才會被允許或拒絕租用IP位址，其他用戶端都會被拒絕或允許
  * 若同時將 __允許__ 與 __拒絕__ 類別篩選都啟用的話，則以 __拒絕__ 的設定優先
    * DHCP伺服器會出租IP位址給列於 __允許__ 類別內的用戶端電腦，只要此電腦沒有被列於 __拒絕__ 類別內

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_28.png)

# 多台DHCP伺服器的split scope高可用性

* 多台DHCP伺服器可以提供高可用性功能
  * 將相同的IP領域建立在這些DHCP伺服器內，各伺服器的領域內包含了適當比率IP位址範圍，但是不可以有重複的IP位址
  * 此高可用性被稱為split scope（拆分領域）

# 80/20分配率

適用於領域內的IP位址數量不是很多的情況

平常由「DHCP伺服器1」來對用戶端提供服務，而「DHCP伺服器2」當作備用伺服器

應將「DHCP伺服器1」放在與用戶端電腦同一個網路內，以便能夠優先對用戶端提供服務，而做為備用伺服器的「DHCP伺服器2」應該要放到另外一個網路內

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_29.png)

# 100/100分配率

適用於領域內的IP位址數量足夠的情況

圖中假設兩個領域的IP位址數量都能夠100%滿足需求

可將兩台伺服器都放在用戶端所在的網路內，讓它們同時對用戶端提供服務；也可以將其中一台放到另一個網路內，做為備用的伺服器

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_30.png)

# 互相備援的DHCP伺服器

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_31.png)

# 子網路延遲設定

* 假設兩台採用80/20分配率的DHCP伺服器位於同一個子網路內
  * DHCP伺服器1是主要伺服器\(80%\)
  * DHCP伺服器2是備援伺服器\(20%\)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_32.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_33.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_34.png)

# DHCP領域劃分設定精靈

* 可自動幫將主要與備援DHCP伺服器的IP位址分配率設定完成
  * 先有一台領域已建立完成的主要伺服器
  * 再架設備援伺服器
  * 透過精靈自動在備援伺服器建立領域，並依照所指定的百分比來設定主要與備援伺服器的IP領域

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_35.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_36.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_37.png)

# DHCP的選項設定

* 可指派選項設定給DHCP用戶端，例如
  * 預設閘道\(路由器\)的IP位址
  * DNS伺服器的IP位址
  * WINS伺服器的IP位址
  * WINS/NBT節點類型
* 當DHCP用戶端租用IP位址或更新IP租約時，就可從DHCP伺服器取得這些選項設定值

# DHCP選項設定的等級

* 伺服器選項
  * 會自動被所有領域來繼承
* 領域選項
  * 當用戶端從此領域租到IP位址時，才會得到這些選項
  * 會自動被該領域內的所有保留區來繼承
* 保留區選項
  * 只有當用戶端租用到保留的IP位址時，才會得到這些選項
* 原則

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_38.png)

# 選項設定的優先順序

* 設定有衝突時，其優先順序為
  * 伺服器選項\(最低\)
  * 領域選項
  * 保留區選項
  * 原則\(最高\)
* 用戶端的設定比DHCP伺服器的選項設定優先
  * 例如DNS伺服器的IP位址設定

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_39.png)

# 設定選項與測試

例如針對領域來設定路由器的IP位址

DHCP用戶端可利用ipconfig /renew指令來測試

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_40.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_41.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_42.png)

# 透過原則來指派IP位址與選項

* 透過 __原則__ 來指派不同的IP位址與選項給指定用戶端
  * 此功能稱為 __原則型指派__ （Policy\-based assignment，PBA）
* 讓您更容易來控管用戶端電腦，例如
  * 可將同一個網路內的桌上型電腦與行動裝置用戶端的IP位址租期分別設定為8天與3小時
  * 可將桌上型電腦與行動裝置用戶端的IP位址範圍分別限定在192\.168\.8\.50 – 192\.168\.8\.100與192\.168\.8\.101 – 192\.168\.8\.150
    * 便於針對桌上型電腦與行動裝置用戶端，來分別給予不同網路流量控制
  * 可以針對不同部門\(例如業務部與企劃部\)的用戶端電腦，來分別給予不同的選項設定，例如不同的預設閘道與DNS伺服器

# DHCP用戶端傳送來的辨識資訊

* MAC位址
* 廠商類別
* 使用者類別
* 用戶端辨識碼
  * 有些用戶端的DHCP要求中內含用戶端辨識碼
  * 用戶端辨識碼 = 硬體類型 \+ MAC，例如若用戶端的硬體類型為01、MAC為000c29b5ef44，則用戶端辨識碼為01000c29b5ef44
  * Ethernet與802\.11無線網路的硬體類型為01
* 轉寄站資訊
  * 若DHCP用戶端的要求是透過DHCP轉寄站轉送的話，則可以透過轉寄站資訊（例如DHCP option 82中的Circuit ID\+Remote ID）來辨識用戶端的來源網路，DHCP伺服器可根據它來出租IP位址
* 實例演練

# DHCP伺服器處理原則的方式 - 1

* 可針對單一領域或伺服器來建立原則。伺服器的原則會被領域來繼承
* DHCP伺服器會先處理領域的原則，再處理伺服器的原則
* 領域原則可僅指派IP位址、或僅指派選項設定、或同時指派IP位址與選項設定給用戶端。伺服器原則無法指派IP位址，只可指派選項設定
* 一個原則內可設定多個條件，它們可是「且」或「或」的關係，例如
  * 第1個條件用來篩選MAC位址為 __00155d\*__ 的用戶端
  * 第2個條件用來篩選 __使用者類別__ 識別碼為 __SALES__ 的用戶端
  * 故若用戶端的MAC位址前6碼為 __00155d__ 、「且」（「或」）其 __使用者類別__ 識別碼為 __SALES__ 的話，就符合本原則的要求條件
* 若在領域內建立多個原則的話，則伺服器會依原則的排列順序來判斷用戶端是否符合原則的條件
  * 若用戶端同時符合多個原則的條件：伺服器會透過第1個原則來指派IP位址給用戶端（若在保留區內有保留IP位址給用戶端的話，則以保留區的優先；但選項設定則以原則的設定優先）

* 若用戶端符合原則的條件，此原則內也有指派IP位址，但是IP位址已經全部用罄的話，則DHCP伺服器會繼續處理下一個原則。若所有原則內的IP位置都已經用罄的話，則用戶端將租用不到IP位址
* 若這些原則內都沒有指派IP位址、或用戶端不符合所有原則內所定義的條件的話，則用戶端會從領域來租用IP位址，但用戶端所租用到的IP位址是扣除原則內所設定的IP位址之外的其餘IP位址
* 以選項設定來說：若用戶端符合多個原則的條件的話，則伺服器會將這些原則內的設定匯總後指派給用戶端電腦。例如第1個原則內指派DNS伺服器、第2個原則內指派預設閘道，則DHCP伺服器會將DNS伺服器與預設閘道都指派給用戶端
  * 若原則內的選項設定有衝突的話，則以排列在前面的優先（先處理的優先），例如第1個原則將DNS伺服器設定為192\.168\.8\.1、第2個將DNS伺服器設定為8\.8\.8\.8，則DHCP伺服器會DNS伺服器192\.168\.8\.1指派給用戶端

# DHCP的類別選項

* 透過 __原則__ 來指派不同的IP位址與選項給指定的DHCP用戶端時，可以透過用戶端所傳送來的 __廠商類別__ 、 __使用者類別__ 來區別用戶端
* __使用者類別__ ：當用戶端向伺服器租用IP位址時，會將類別識別碼一併傳送給伺服器，而伺服器會依據此類別識別碼來給予這些用戶端專有的選項設定
* __廠商類別__ ：可以根據作業系統廠商所提供的 __廠商類別__ 識別碼來設定選項。Windows Server 2016 DHCP伺服器已具備辨識Windows用戶端的能力，並透過4個內建的廠商類別選項來設定用戶端的DHCP選項
  * DHCP Standard Options：適用於所有的用戶端
  * Microsoft Windows 2000選項：適用於Windows 2000（含）後的用戶端
  * Microsoft Windows 98選項：適用於Windows 98/ME用戶端
  * Microsoft 選項：適用於其他的Windows用戶端

若要支援其他作業系統的話，請先查詢其 __廠商類別__ 識別碼，然後在DHCP伺服器內新增此 __廠商類別__ 識別碼，並設定這些用戶端的選項。Android系統的 __廠商類別__ 識別碼的前6碼為 __dhcpcd__ ，因此可利用 __dhcpcd__  __\*__ 來代表所有的Android裝置

---

需替用戶端設定使用者類別識別碼

# 在DHCP伺服器新增使用者類別識別碼

* 假設用戶端的使用者類別識別碼為SALES
  * 大小寫有差別

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_43.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_44.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_45.png)

---

若要新增廠商類別識別碼的話：對著IPv4按右鍵定義廠商類別

# 在伺服器內針對識別碼SALES設定類別選項

將用戶端的DNS伺服器的IP位址設定為192\.168\.8\.1

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_46.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_47.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_48.png)

# DHCP用戶端的設定

* 將使用者類別識別碼設定為SALES
* 利用ipconfig /renew指令來測試是否可取得選項設定值
* 清除使用者類別識別碼
  * ipconfig /setclassid“乙太網路”

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_49.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_50.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_51.png)

# DHCP伺服器與用戶端位於不同網段的情況

* DHCP訊息以廣播為主，此訊息無法透過路由器傳遞到另一個網路
* 可以採用以下方法之一來解決此問題
  * 在每一個網路內都安裝一台DHCP伺服器
  * 選用符合RFC 1542規格的路由器
  * 透過DHCP轉送代理的協助

# 選用RFC 1542路由器

1:DHCPDISCOVER

2:DHCPDISCOVER

3:直接訊息

4:DHCPOFFER

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_52.png)

\* DHCPREQUEST訊息與DHCPACK訊息，也都是透過路由器來轉送

# DHCP轉送代理

1:DHCPDISCOVER

2:直接訊息

3:直接訊息

4:DHCPOFFER

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_53.png)

\* DHCPREQUEST訊息與DHCPACK訊息，也都是透過 __DHCP__  __轉送__  __  代理__ 來轉送

# 設定DHCP轉送代理

需安裝 __遠端存取__ 角色內的 __DirectAccess__  __與__  __VPN\(RAS\)__ 角色服務

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_54.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_55.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_56.png)

\*先新增 __DHCP Relay Agent__ 路由通訊協定

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_57.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_58.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_59.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_60.png)

# 超級領域

* 若一個實體網路內的電腦數量較多，以致於一個網路識別碼所提供的IP位址不夠使用:
  * 利用路由器將網路切割成多個實體子網路，每一個子網路分配一個網路識別碼
  * Multinets：一個實體網路內有多個邏輯的IP網路，也就是直接提供多個網路識別碼給這個實體網路，讓不同的電腦可有不同的網路識別碼

* 超級領域
  * 由多個領域所組合成，用來將IP位址出租給multinets內的DHCP用戶端

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_61.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_62.png)

---

路由器在甲網路的介面必須設定2個IP位址，其網路識別碼分別是192.168.8.0與192.168.10.0，它讓甲網路內兩個邏輯網路（192.168.8.0、192.168.10.0）內的電腦之間可以透過路由器來溝通

# 建立超級領域

DHCP主控台中對著IPv4按右鍵新增超級領域

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_63.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_64.png)

# 多點傳送領域

* 可出租 __多點傳送位址__ \(Class D\)
  * 範圍為224\.0\.0\.0－239\.255\.255\.255
  * 它是群組位址，多台主機可同時登記在此群組位址之下
  * 傳送給此位址的封包，會同時送給此群組內的所有主機
  * 可以降低網路的負擔
* 透過Multicast Dynamic Client Allocation Protocol \(MADCAP\)來向DHCP伺服器組用

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_65.png)

# 建立多點傳送領域

* 管理領域
  * 從239\.192\.0\.0 開始，子網路遮罩為255\.252\.0\.0
  * 共可以提供2 ^ 18 = 262\,1444個多點傳送群組位址
  * 適合公司內部使用，性質類似於 __私人__ IP
* 通用領域
  * 從233\.0\.0\.0開始，子網路遮罩為255\.255\.255\.0
  * 它讓每一家公司可以有255個多點傳送群組位址
  * 此範圍的位址適合使用在網際網路
* DHCP主控台中對著IPv4按右鍵新增多點傳送領域

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_66.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_67.png)

# DHCP資料庫的維護

資料庫內儲存著IP領域、出租位址、保留位址與選項設定等

dhcp\.mdb與其它輔助性檔案

可透過【對著DHCP伺服器按右鍵內容進階資料庫路徑】的途徑來修改儲存路徑

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_68.png)

# 資料庫的備份

* 自動備份
  * 預設每隔60分鐘會自動備份到dhcp\\backup\\new資料夾內
  * 可變更間隔時間
  * HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DHCPServer\\Parameters\\BackupInterval
* 手動備份
  * 對著DHCP伺服器按右鍵備份
  * 會將其備份到指定的資料夾內，預設為
  * % _Systemroot_ %\\System32\\Dhcp\\backup\\new
    * 修改預設路徑：對著DHCP伺服器按右鍵內容進階備份路徑

# 資料庫的還原

* 自動還原
  * DHCP服務啟動時若檢查到DHCP資料庫損毀，它會自動修復資料庫
  * 利用% _Systemroot_ %\\System32\\Dhcp\\backup\\new資料夾內的備份檔
* 手動還原
  * 對著DHCP伺服器按右鍵還原
* 若將位於以下路徑的登錄值設為1，則重新啟動DHCP服務時會執行還原工作，不論資料庫是否損毀
* HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\        DHCPServer\\Parameters\\RestoreFlag

# 領域的調解

* DHCP資料庫:儲存IP位址租用詳細資訊
* 登錄資料庫:儲存IP位址租用摘要資訊
* 若兩處的資料不一致
  * 例如DHCP資料庫損毀後還原舊資料庫，因而與登錄資料庫不一致
  * 調解:可讓系統根據登錄資料庫的內容來更新DHCP資料庫
* 對著領域按右鍵調解按 __檢查__ 鈕，或對著I __Pv4__ 按右鍵調解所有的領域按 __檢查__ 鈕

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_69.png)

# 將DHCP資料庫搬移到其它的伺服器

* 開啟DHCP主控台對著 DHCP伺服器按右鍵備份
  * 例如備份到C:\\DHCPBackup資料夾，其內包含著new子資料夾
* 對著DHCP伺服器按右鍵所有工作停止
  * 或執行net stop dhcpserver
* 開始系統管理工具服務雙擊DHCP伺服器 __啟動類型__ 處選擇 __停用__
* 將所備份的資料庫檔案拷貝到新的 DHCP伺服器內
* 在新DHCP伺服器上透過安裝DHCP伺服器角色
* 開啟DHCP主控台對著 DHCP伺服器按右鍵還原
  * 例如選擇C:\\DHCPBackup\(不是C:\\DHCPBackup\\new\)

# 監視DHCP伺服器的運作

* 可以協助您瞭解伺服器的運作情況，以便找出效能瓶頸、問題所在與作為改善的參考
* DHCP伺服器的統計資料
  * 先啟用DHCP統計資料自動更新功能

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_70.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_71.png)

# DHCP伺服器與領域的的統計資料

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_72.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_73.png)

\* 若要檢視某個領域的統計資料的話：【對著該領域按右鍵顯示統計資料】

# DHCP稽核記錄檔

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_74.png)

* 記錄著以下的事件
  * 服務的啟動與停止時間
  * 伺服器是否已被授權
  * IP位址的出租、更新、釋放與拒絕等
* 先確認已經勾選 __啟用__ DHCP __稽核記錄__

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_75.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_76.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_77.png)

# IPv6位址

* IPv6主機會自動設定自己的IPv6位址
* 可以另外再透過路由器內的設定來取得更多的IPv6位址
* 不同類型的IPv6位址有著不同的用途
  * 有的IPv6位址可以用來與同一個 __連結__ 內的主機溝通
  * 有的IPv6位址可以用來連接網際網路

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_78.png)

# 手動設定IPv6位址與測試

有些主機或設備需手動設定IPv6位址，例如伺服器、路由器或使用靜態IP位址的主機

測試時注意Windows __防火牆__ 是否封鎖ICMP封包

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_79.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_80.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_81.png)

---

除了手動設定的IPv6位址之外，還有主機自動設定的link-local位址(連結-本機IPv6位址)

# DHCPv6與DHCPv6領域

DHCPv6用戶端會在網路上找尋路由器，然後透過路由器所傳回的設定值來決定是否要向DHCP伺服器索取更多的IPv6位址與選項設定

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_82.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_83.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_84.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_85.png)

---

也可以設定IPv6選項設定，例如DNS伺服器的IPv6位址，但是無法設定預設閘道的IPv6位址，因為DHCPv6用戶端會透過路由器所傳回的資訊來自動設定預設閘道與路由表

# DHCP伺服器傳統的高可用性功能

* Windows系統內建的容錯移轉叢集
  * 主動節點與被動節點聯手來提供一個高可用性的環境
  * 有儲存媒體單點失敗的風險，因此需要在儲存媒體上做更多的投資，而且其設定複雜、比較不易維護
* 拆分領域（split scope）
  * 比較不容易來決定領域的分配比率；可能會有主要伺服器故障，但是備援伺服器的IP位址不夠用的狀況發生；需要在每台伺服器內分別設定相同的選項設定

# DHCP容錯移轉（DHCP failover）

* 最多支援2台DHCP伺服器、僅支援IPv4領域
* 2台DHCP伺服器的領域設定與租用資訊相同
  * 當1台DHCP伺服器故障時，用戶端仍然可以繼續透過另1台DHCP伺服器來更新租約、繼續使用原來所租用的IP位址
* 可以採用 __負載平衡__ 或 __熱待命__ 模式來運作

# 負載平衡模式

2台伺服器會分散負擔來同時對用戶端提供服務。它們會相互將領域資訊複製給對方

較適合於2台伺服器是位於同一個實體站台內的場合

可以同時對站台內的1或多個子網路來提供服務

# 熱待命模式

同一時間內只有1台伺服器（ __使用中伺服器__ 、 __主要伺服器__ ）對用戶端提供服務

另1台 __待命伺服器（次要伺服器）__ 會接收由 __使用中伺服器__ 複製來的領域資訊。當 __使用中伺服器__ 故障時， __待命伺服器__ 就會接手

較適合於需要在遠端站台來建立 __待命伺服器__ 的場合，如圖中央站台內的伺服器是站台1與站台2內 __使用中伺服器__ 的 __待命伺服器__ ，其內的2個領域分別與站台1、站台2的領域相同

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_86.png)

# DHCP容錯移轉實例演練 - 1

採用Active Directory網域環境\(工作群組環境亦可\)

確認DHCP1內已經建立了領域（本範例採用之前立的環境），但暫時將其租用期間改為1分鐘，以便於能夠快速來驗證容錯移轉功能

在DHCP2電腦上安裝作業系統、設定好TCP/IP組態、將其加入網域、安裝DHCP角色

到DHCP1電腦上利用網域Administrator身份登入

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_87.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_88.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_89.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_90.png)

* 負載平衡百分比
  * 負責發放的IP位址比率
  * 伺服器每隔5分鐘自動檢查、調整可用IP位址比率
* 狀態轉換間隔
  * 自動從 __通訊中斷__ 轉換為 __夥伴停機__ 狀態之間的等待時間\(預設為手動轉換\)
* 用戶端前置重疊時間上限
  * __夥伴停機__ 後，到取得其完整控制權（接管夥伴伺服器尚未出租的可用IP位址）之間的等待時間
  * 也用來設定在尚未取得完整控制權之前，新用戶端租約的暫時有效期限

---

2台伺服器的時間差異不可多於60秒
伺服器是利用用戶端的MAC與一個邏輯演算法來算出雜湊值，並根據此雜湊值來決定將用戶端要求交給其中一台伺服器來負責

* __熱__  __待命__ 模式
  * 需選擇將夥伴伺服器設定為 __待命__ 或 __使用中__ 伺服器
  * 還需設定保留給 __待命__ 伺服器的IP位址百分比，若 __使用中伺服器__ 故障，且 __待命伺服器__ 尚未取得完整控制權之前，可以選擇這些IP位址來出租給用戶端

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_91.png)

檢視DHCP容錯移轉設定與領域統計資料

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_92.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_93.png)

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_94.png)

---

若與夥伴伺服器之間連線中斷的話，則可以透過變更為合作夥伴往下來將通訊中斷狀態手動轉換為夥伴停機狀態


# 容錯移轉測試

在用戶端Win10PC上執行 __ipconfig__  __ /all__ 指令來查看，得知它是向DHCP1\(192\.168\.8\.2\)租用IP位址

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_95.png)

將DHCP1伺服器關機。到用戶端等超過1分鐘租約到期後，再執行 __ipconfig__  __ /all__ 指令

![](WS2016%E7%B6%B2%E8%B7%AF%E8%88%87%E7%B6%B2%E7%AB%99%E5%BB%BA%E7%BD%AE%E5%AF%A6%E5%8B%99-CA240-Ch02-%E5%88%A9%E7%94%A8DHCP%E8%87%AA%E5%8B%95%E6%8C%87%E6%B4%BEIP%E4%BD%8D%E5%9D%80_96.png)

